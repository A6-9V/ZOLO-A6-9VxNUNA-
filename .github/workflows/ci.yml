name: CI - PowerShell Scripts

on:
  push:
    branches: [ main, develop, copilot/** ]
    paths:
      - '**.ps1'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.ps1'

jobs:
  powershell-lint:
    name: Lint PowerShell Scripts
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install PSScriptAnalyzer
      shell: powershell
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck
        
    - name: Run PSScriptAnalyzer
      shell: powershell
      run: |
        $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings PSGallery
        if ($results) {
          $results | Format-Table -AutoSize
          Write-Error "PSScriptAnalyzer found issues"
          exit 1
        } else {
          Write-Host "No issues found by PSScriptAnalyzer" -ForegroundColor Green
        }
        
  powershell-test:
    name: Test PowerShell Scripts
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Script Syntax
      shell: powershell
      run: |
        $scripts = Get-ChildItem -Path . -Filter *.ps1 -Recurse -File
        $failed = 0
        foreach ($script in $scripts) {
          try {
            $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $script.FullName -Raw), [ref]$null)
            Write-Host "✓ $($script.Name)" -ForegroundColor Green
          } catch {
            Write-Host "✗ $($script.Name): $($_.Exception.Message)" -ForegroundColor Red
            $failed++
          }
        }
        if ($failed -gt 0) {
          Write-Error "$failed script(s) failed syntax check"
          exit 1
        }
