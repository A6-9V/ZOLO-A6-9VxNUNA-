name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  security-audit:
    name: Security Audit
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for Hardcoded Credentials
      shell: powershell
      run: |
        $patterns = @(
          'password\s*=\s*[''"](?!your_password|placeholder|example|YOUR_|<<|{{\s*secrets).*[''"]',
          'token\s*=\s*[''"](?!your_token|placeholder|example|YOUR_|ghp_xxx|<<|{{\s*secrets).*[''"]',
          'api[_-]?key\s*=\s*[''"](?!your|placeholder|example|YOUR_|<<|{{\s*secrets).*[''"]',
          'secret\s*=\s*[''"](?!your|placeholder|example|YOUR_|<<|{{\s*secrets).*[''"]'
        )
        
        $excludeFiles = @('*.md', '*GUIDE.md', '*README.md', '*SETUP.md', '*-EXAMPLE.*', '*.example.*')
        $files = Get-ChildItem -Path . -Include *.ps1,*.json,*.txt,*.py -Recurse -File | 
                 Where-Object { 
                   $_.FullName -notmatch '\\\.git\\' -and
                   $excludeFiles -notcontains $_.Name -and
                   $_.Name -notmatch 'GUIDE|README|SETUP|EXAMPLE|example'
                 }
        
        $issues = @()
        foreach ($file in $files) {
          $content = Get-Content $file.FullName -Raw
          foreach ($pattern in $patterns) {
            if ($content -match $pattern) {
              # Additional check: skip if line contains common placeholder indicators
              $matches = Select-String -Path $file.FullName -Pattern $pattern
              $realIssues = $matches | Where-Object {
                $_.Line -notmatch 'example|placeholder|YOUR_|demo|test|sample|\<\<|\{\{'
              }
              if ($realIssues) {
                $issues += "Potential real credential in $($file.Name) at line $($realIssues[0].LineNumber)"
              }
            }
          }
        }
        
        if ($issues.Count -gt 0) {
          Write-Warning "⚠️ Potential security issues found:"
          $issues | ForEach-Object { Write-Warning "  $_" }
          Write-Warning "`nℹ️ If these are false positives (examples/placeholders), you can ignore them."
        } else {
          Write-Host "✅ No hardcoded credentials found" -ForegroundColor Green
        }
